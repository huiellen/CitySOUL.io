<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CitySOUL - Urban Cultural Memory Platform</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
        .map-point {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease;
            z-index: 10;
        }
        .map-point:hover {
            transform: scale(1.5);
        }
        .audio-progress {
            transition: width 0.1s linear;
        }
        #mapid { 
            height: 100%; 
            min-height: 450px;
            width: 100%;
            z-index: 1;
        }
        .custom-popup .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .custom-marker-icon {
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .filters-panel {
                position: fixed;
                left: -100%;
                top: 0;
                bottom: 0;
                width: 85%;
                max-width: 300px;
                z-index: 40;
                transition: left 0.3s ease;
                overflow-y: auto;
            }
            
            .filters-panel.active {
                left: 0;
            }
            
            .filters-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 39;
                display: none;
            }
            
            .filters-overlay.active {
                display: block;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- Header Navigation -->
    <header class="bg-indigo-700 text-white p-4 sticky top-0 z-50">
        <div class="flex justify-between items-center max-w-6xl mx-auto">
            <div class="flex items-center space-x-2">
                <i class="fas fa-compass text-xl"></i>
                <h1 class="text-xl font-bold">CitySOUL</h1>
            </div>
            
            <div class="hidden md:flex space-x-6">
                <button class="flex items-center font-bold" id="map-nav-btn">
                    <i class="fas fa-map-marked-alt mr-1"></i> Map
                </button>
                <button class="flex items-center" id="themes-nav-btn">
                    <i class="fas fa-compass mr-1"></i> Themes
                </button>
                <button class="flex items-center" id="saved-nav-btn">
                    <i class="fas fa-bookmark mr-1"></i> Saved Items (<span id="saved-count">0</span>)
                </button>
                <button class="flex items-center" id="social-service-btn">
                    <i class="fas fa-hands-helping mr-1"></i> Social Service
                </button>
                <button class="flex items-center" id="add-memory-btn">
                    <i class="fas fa-plus-circle mr-1"></i> Add Memory
                </button>
            </div>
            
            <div class="flex items-center space-x-3">
                <button id="login-btn" class="bg-white text-indigo-700 px-3 py-1 rounded-full text-sm font-medium">
                    <i class="fas fa-user mr-1"></i> Log In
                </button>
                <button id="mobile-menu-btn" class="md:hidden text-white">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </div>
        
        <!-- Mobile menu (hidden by default) -->
        <div id="mobile-menu" class="mt-4 md:hidden hidden">
            <div class="flex flex-col space-y-4">
                <button class="flex items-center font-bold" id="mobile-map-btn">
                    <i class="fas fa-map-marked-alt mr-2"></i> Map View
                </button>
                <button class="flex items-center" id="mobile-themes-btn">
                    <i class="fas fa-compass mr-2"></i> Thematic Discovery
                </button>
                <button class="flex items-center" id="mobile-saved-btn">
                    <i class="fas fa-bookmark mr-2"></i> Saved Items (<span class="mobile-saved-count">0</span>)
                </button>
                <button class="flex items-center" id="mobile-social-btn">
                    <i class="fas fa-hands-helping mr-2"></i> Social Service
                </button>
                <button class="flex items-center" id="mobile-add-memory-btn">
                    <i class="fas fa-plus-circle mr-2"></i> Add Memory
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Container -->
    <main class="flex-1">
        <!-- Map View -->
        <div id="map-view" class="flex flex-col md:flex-row h-full">
            <!-- Filters panel -->
            <div class="filters-panel w-full md:w-80 bg-white p-4 border-r border-gray-200 overflow-y-auto" id="filters-panel">
                <div class="flex justify-between items-center mb-4 md:hidden">
                    <h2 class="text-xl font-semibold">Filters</h2>
                    <button id="close-filters-btn" class="text-gray-500">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-search mr-2"></i>
                    Filtered Search
                </h2>
                
                <div class="space-y-6">
                    <!-- Categories filter -->
                    <div>
                        <h3 class="font-medium mb-2">Categories</h3>
                        <div class="space-y-1 category-filters">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" class="mr-2" value="Food"> Food
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" class="mr-2" value="Festival"> Festival
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" class="mr-2" value="Architecture"> Architecture
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" class="mr-2" value="Performance"> Performance
                            </label>
                        </div>
                    </div>
                    
                    <!-- Time periods filter -->
                    <div>
                        <h3 class="font-medium mb-2">Time Periods</h3>
                        <div class="space-y-1 period-filters">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" class="mr-2" value="1940-1960"> 1940-1960
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" class="mr-2" value="1950-1980"> 1950-1980
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" class="mr-2" value="1970-1990"> 1970-1990
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" class="mr-2" value="1990-2010"> 1990-2010
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" class="mr-2" value="2000-2020"> 2000-2020
                            </label>
                        </div>
                    </div>
                    
                    <!-- Districts filter -->
                    <div>
                        <h3 class="font-medium mb-2">Districts</h3>
                        <div class="space-y-1 district-filters">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" class="mr-2" value="Macau Peninsula"> Macau Peninsula
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" class="mr-2" value="Taipa"> Taipa
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" class="mr-2" value="Cotai"> Cotai
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" class="mr-2" value="Coloane"> Coloane
                            </label>
                        </div>
                    </div>
                    
                    <!-- Clear filters -->
                    <button id="clear-filters-btn" class="w-full py-2 bg-gray-100 text-gray-700 rounded font-medium hover:bg-gray-200 transition">
                        Clear All Filters
                    </button>
                </div>
            </div>
            
            <!-- Overlay for filters panel on mobile -->
            <div class="filters-overlay" id="filters-overlay"></div>
            
            <!-- Map area -->
            <div class="flex-1 relative bg-blue-50 min-h-96">
                <!-- Show filters button (mobile only) -->
                <button 
                    id="show-filters-btn" 
                    class="md:hidden absolute top-4 left-4 z-20 bg-white p-2 rounded-lg shadow-md"
                >
                    <i class="fas fa-filter"></i> Filters
                </button>
                
                <!-- Results counter -->
                <div class="absolute top-4 right-4 z-20 bg-white px-3 py-2 rounded-lg shadow-md">
                    <span id="results-count" class="font-medium">5</span> memories found
                </div>
                
                <!-- The actual map -->
                <div id="mapid" class="z-10"></div>
            </div>
        </div>

        <!-- Item Details View (hidden by default) -->
        <div id="details-view" class="bg-white h-full overflow-y-auto hidden">
            <div class="max-w-4xl mx-auto p-4 md:p-8" id="detail-content">
                <!-- Content populated dynamically by JavaScript -->
            </div>
        </div>

        <!-- Themes View (hidden by default) -->
        <div id="themes-view" class="hidden">
            <div class="max-w-6xl mx-auto p-4 md:p-8">
                <div class="mb-8">
                    <h1 class="text-2xl font-bold mb-2">Thematic Discovery</h1>
                    <p class="text-gray-600">
                        Explore curated collections of cultural memories connected through common narratives and themes.
                    </p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="themes-container">
                    <!-- Themes populated dynamically by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Saved Items View (hidden by default) -->
        <div id="saved-view" class="hidden">
            <div class="max-w-6xl mx-auto p-4 md:p-8">
                <div class="mb-8">
                    <h1 class="text-2xl font-bold mb-2">My Saved Items</h1>
                    <p class="text-gray-600">
                        Access and manage your collection of saved cultural memories.
                    </p>
                </div>
                
                <div id="saved-items-container">
                    <!-- Saved items populated dynamically by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Social Service View (hidden by default) -->
        <div id="social-service-view" class="hidden">
            <div class="max-w-6xl mx-auto p-4 md:p-8">
                <div class="mb-8">
                    <h1 class="text-2xl font-bold mb-2">CitySOUL Social Service</h1>
                    <p class="text-gray-600 mb-4">
                        Transform passive browsing into active engagement by participating in preserving local heritage.
                    </p>
                    <p class="text-gray-600">
                        From oral history interviews to walking tours and neighborhood festivals, join us in making cultural preservation an inclusive and participatory process.
                    </p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Opportunities cards -->
                    <div class="border rounded-xl overflow-hidden shadow-md hover:shadow-lg transition">
                        <div class="h-40 bg-indigo-100 flex items-center justify-center">
                            <i class="fas fa-microphone-alt text-4xl text-indigo-500"></i>
                        </div>
                        <div class="p-4">
                            <h2 class="text-xl font-semibold mb-2">Oral History Project</h2>
                            <p class="text-gray-600 mb-4">Interview long-time residents to document their memories of Macau's cultural heritage.</p>
                            <button class="bg-indigo-600 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-700 transition">
                                Volunteer Now
                            </button>
                        </div>
                    </div>
                    
                    <div class="border rounded-xl overflow-hidden shadow-md hover:shadow-lg transition">
                        <div class="h-40 bg-purple-100 flex items-center justify-center">
                            <i class="fas fa-route text-4xl text-purple-500"></i>
                        </div>
                        <div class="p-4">
                            <h2 class="text-xl font-semibold mb-2">Walking Tour Guide</h2>
                            <p class="text-gray-600 mb-4">Lead tours highlighting historical and cultural landmarks in your neighborhood.</p>
                            <button class="bg-indigo-600 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-700 transition">
                                Apply as Guide
                            </button>
                        </div>
                    </div>
                    
                    <div class="border rounded-xl overflow-hidden shadow-md hover:shadow-lg transition">
                        <div class="h-40 bg-green-100 flex items-center justify-center">
                            <i class="fas fa-camera text-4xl text-green-500"></i>
                        </div>
                        <div class="p-4">
                            <h2 class="text-xl font-semibold mb-2">Photo Documentation</h2>
                            <p class="text-gray-600 mb-4">Contribute to our visual archive by documenting changing urban landscapes.</p>
                            <button class="bg-indigo-600 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-700 transition">
                                Submit Photos
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-100 rounded-xl p-6">
                    <h2 class="text-xl font-semibold mb-4">Upcoming Community Events</h2>
                    
                    <div class="space-y-4">
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-medium">Cultural Memory Workshop</h3>
                                    <p class="text-gray-600 text-sm mt-1">Learn techniques for documenting oral histories and personal narratives.</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-indigo-600 font-medium">Apr 15, 2025</div>
                                    <div class="text-gray-500 text-sm">2:00 - 4:00 PM</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-medium">Neighborhood Festival Planning</h3>
                                    <p class="text-gray-600 text-sm mt-1">Help organize a celebration of local culture and traditions.</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-indigo-600 font-medium">Apr 22, 2025</div>
                                    <div class="text-gray-500 text-sm">5:30 - 7:00 PM</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-medium">Heritage Preservation Forum</h3>
                                    <p class="text-gray-600 text-sm mt-1">Join the discussion on protecting and preserving Macau's cultural sites.</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-indigo-600 font-medium">May 5, 2025</div>
                                    <div class="text-gray-500 text-sm">1:00 - 3:30 PM</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Login Modal (hidden by default) -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Log In</h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-sm font-medium mb-1">Email Address</label>
                    <input 
                        type="email" 
                        class="w-full p-2 border rounded-lg"
                        placeholder="you@example.com"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Password</label>
                    <input 
                        type="password" 
                        class="w-full p-2 border rounded-lg"
                        placeholder="••••••••"
                    />
                </div>
            </div>
            
            <div class="flex justify-between items-center mb-4">
                <label class="flex items-center text-sm">
                    <input type="checkbox" class="mr-2" />
                    Remember me
                </label>
                <a href="#" class="text-sm text-indigo-600">Forgot password?</a>
            </div>
            
            <div class="space-y-3">
                <button 
                    id="login-submit-btn"
                    class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition"
                >
                    Log In
                </button>
                <button class="w-full bg-white border py-2 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                    Sign Up
                </button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- JavaScript -->
    <script>
        // Sample data for demonstration - with Macau coordinates
        const CULTURAL_DATA = [
            {
                id: 1,
                title: "Traditional Market on Rua do Cunha",
                description: "A busy traditional market in Taipa Village that has existed since the 1950s, known for fresh local produce and cultural exchanges.",
                category: "Food",
                period: "1950-1980",
                district: "Taipa",
                location: { lat: 22.156, lng: 113.559 },
                images: ["C:\\Users\\17368\\Desktop\\webdemo\\images\\1.jpg", "https://placehold.co/500x300?text=Market+Photo+2"],
                audio: true,
                tags: ["market", "food", "heritage", "community"],
                contributor: "John Doe"
            },
            {
                id: 2,
                title: "Annual Festival of Kun Iam Temple",
                description: "Documentation of the annual festival that takes place at Kun Iam Temple, featuring traditional performances and crafts.",
                category: "Festival",
                period: "1990-2010",
                district: "Macau Peninsula",
                location: { lat: 22.193, lng: 113.541 },
                images: ["https://placehold.co/500x300?text=Temple+Festival"],
                audio: false,
                tags: ["festival", "temple", "tradition", "celebration"],
                contributor: "Xiao Ming"
            },
            {
                id: 3,
                title: "Colonial Architecture of Senado Square",
                description: "The iconic buildings around Senado Square represent an important architectural movement in the city's development.",
                category: "Architecture",
                period: "1970-1990",
                district: "Macau Peninsula",
                location: { lat: 22.1932, lng: 113.5389 },
                images: ["https://placehold.co/500x300?text=Senado+Square+1", "https://placehold.co/500x300?text=Senado+Square+2", "https://placehold.co/500x300?text=Senado+Square+3"],
                audio: true,
                tags: ["architecture", "colonial", "heritage", "square"],
                contributor: "Sakamoto"
            },
            {
                id: 4,
                title: "Grandmother's Macanese Recipe Stories",
                description: "Oral history recording of traditional Macanese recipes and cooking techniques passed down through three generations.",
                category: "Food",
                period: "1940-1960",
                district: "Coloane",
                location: { lat: 22.1254, lng: 113.5644 },
                images: ["https://placehold.co/500x300?text=Kitchen+Stories"],
                audio: true,
                tags: ["food", "recipes", "oral history", "tradition"],
                contributor: "KitSan Ho"
            },
            {
                id: 5,
                title: "Street Performance Culture at Cotai Strip",
                description: "Documentation of street performers who gathered at the Cotai Strip during the early 2000s.",
                category: "Performance",
                period: "2000-2020",
                district: "Cotai",
                location: { lat: 22.1447, lng: 113.5647 },
                images: ["https://placehold.co/500x300?text=Street+Performance+1", "https://placehold.co/500x300?text=Street+Performance+2"],
                audio: false,
                tags: ["performance", "music", "culture", "urban"],
                contributor: "Dean Smith"
            }
        ];

        // Thematic collections
        const THEMATIC_COLLECTIONS = [
            {
                id: 1,
                title: "Macau's Food Heritage",
                description: "Exploring the evolution of food culture in Macau over the decades",
                image: "https://placehold.co/600x300?text=Food+Heritage",
                items: [1, 4]
            },
            {
                id: 2,
                title: "Traditional Festivals",
                description: "Documenting traditional celebrations that are becoming less common in modern urban life",
                image: "https://placehold.co/600x300?text=Traditional+Festivals",
                items: [2]
            },
            {
                id: 3,
                title: "Architectural Heritage",
                description: "Significant buildings and structures that shaped Macau's urban landscape",
                image: "https://placehold.co/600x300?text=Architectural+Heritage",
                items: [3]
            }
        ];

        // State management
        let currentView = 'map';
        let selectedItem = null;
        let isLoggedIn = false;
        let savedItems = [];
        let audioPlaying = false;
        let filteredData = [...CULTURAL_DATA];
        let activeFilters = {
            categories: [],
            periods: [],
            districts: []
        };
        let map = null;
        let markers = [];

        // DOM Elements
        const mapView = document.getElementById('map-view');
        const detailsView = document.getElementById('details-view');
        const themesView = document.getElementById('themes-view');
        const savedView = document.getElementById('saved-view');
        const socialServiceView = document.getElementById('social-service-view');
        const loginModal = document.getElementById('login-modal');
        const mobileMenu = document.getElementById('mobile-menu');
        const filtersPanel = document.getElementById('filters-panel');
        const filtersOverlay = document.getElementById('filters-overlay');
        const detailContent = document.getElementById('detail-content');
        const themesContainer = document.getElementById('themes-container');
        const savedItemsContainer = document.getElementById('saved-items-container');
        const resultsCount = document.getElementById('results-count');
        const savedCountElements = document.querySelectorAll('#saved-count, .mobile-saved-count');

        // Initialize the application
        function initApp() {
            setupEventListeners();
            initMap();
            renderMapMarkers();
            renderThematicCollections();
            updateSavedItemsCount();
            renderSavedItems();
            
            // Load saved items from localStorage if available
            const storedItems = localStorage.getItem('citysoul-saved-items');
            if (storedItems) {
                savedItems = JSON.parse(storedItems);
                updateSavedItemsCount();
                renderSavedItems();
            }
            
            // Check if user was previously logged in
            const loggedInStatus = localStorage.getItem('citysoul-logged-in');
            if (loggedInStatus === 'true') {
                isLoggedIn = true;
                updateLoginButton();
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Navigation buttons
            document.getElementById('map-nav-btn').addEventListener('click', () => setView('map'));
            document.getElementById('themes-nav-btn').addEventListener('click', () => setView('themes'));
            document.getElementById('saved-nav-btn').addEventListener('click', () => {
                if (isLoggedIn) {
                    setView('saved');
                } else {
                    toggleLoginModal(true);
                }
            });
            document.getElementById('social-service-btn').addEventListener('click', () => setView('social-service'));
            
            // Mobile navigation
            document.getElementById('mobile-menu-btn').addEventListener('click', toggleMobileMenu);
            document.getElementById('mobile-map-btn').addEventListener('click', () => {
                setView('map');
                toggleMobileMenu(false);
            });
            document.getElementById('mobile-themes-btn').addEventListener('click', () => {
                setView('themes');
                toggleMobileMenu(false);
            });
            document.getElementById('mobile-saved-btn').addEventListener('click', () => {
                if (isLoggedIn) {
                    setView('saved');
                    toggleMobileMenu(false);
                } else {
                    toggleLoginModal(true);
                }
            });
            document.getElementById('mobile-social-btn').addEventListener('click', () => {
                setView('social-service');
                toggleMobileMenu(false);
            });
            
            // Login modal
            document.getElementById('login-btn').addEventListener('click', () => toggleLoginModal(true));
            document.getElementById('close-modal-btn').addEventListener('click', () => toggleLoginModal(false));
            document.getElementById('login-submit-btn').addEventListener('click', handleLogin);
            
            // Filters
            document.getElementById('clear-filters-btn').addEventListener('click', clearAllFilters);
            document.getElementById('show-filters-btn').addEventListener('click', () => toggleFilterPanel(true));
            document.getElementById('close-filters-btn').addEventListener('click', () => toggleFilterPanel(false));
            document.getElementById('filters-overlay').addEventListener('click', () => toggleFilterPanel(false));
            
            // Setup filter change listeners
            setupFilterListeners('.category-filters input', 'categories');
            setupFilterListeners('.period-filters input', 'periods');
            setupFilterListeners('.district-filters input', 'districts');
        }

        // Toggle filter panel visibility (mobile)
        function toggleFilterPanel(show) {
            if (show) {
                filtersPanel.classList.add('active');
                filtersOverlay.classList.add('active');
            } else {
                filtersPanel.classList.remove('active');
                filtersOverlay.classList.remove('active');
            }
        }

        // Initialize Leaflet map
        function initMap() {
            // Create map centered on Macau
            map = L.map('mapid').setView([22.1667, 113.5500], 13);
            
            // Add OpenStreetMap tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Resize map when view becomes visible (fixes rendering issues)
            map.on('load', function() {
                setTimeout(function() {
                    map.invalidateSize();
                }, 100);
            });
        }

        // Set up filter change listeners for a specific filter type
        function setupFilterListeners(selector, filterType) {
            const filterElements = document.querySelectorAll(selector);
            filterElements.forEach(element => {
                element.addEventListener('change', () => {
                    if (element.checked) {
                        activeFilters[filterType].push(element.value);
                    } else {
                        activeFilters[filterType] = activeFilters[filterType].filter(value => value !== element.value);
                    }
                    applyFilters();
                });
            });
        }

        // Clear all active filters
        function clearAllFilters() {
            activeFilters = {
                categories: [],
                periods: [],
                districts: []
            };
            
            // Uncheck all filter checkboxes
            document.querySelectorAll('.category-filters input, .period-filters input, .district-filters input').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            applyFilters();
        }

        // Apply current filters to data
        function applyFilters() {
            filteredData = [...CULTURAL_DATA];
            
            // Apply category filters
            if (activeFilters.categories.length > 0) {
                filteredData = filteredData.filter(item => activeFilters.categories.includes(item.category));
            }
            
            // Apply period filters
            if (activeFilters.periods.length > 0) {
                filteredData = filteredData.filter(item => activeFilters.periods.includes(item.period));
            }
            
            // Apply district filters
            if (activeFilters.districts.length > 0) {
                filteredData = filteredData.filter(item => activeFilters.districts.includes(item.district));
            }
            
            // Update UI with filtered data
            renderMapMarkers();
            updateResultsCount();
            
            // On mobile, close the filter panel after applying filters
            if (window.innerWidth < 768) {
                toggleFilterPanel(false);
            }
        }

        // Update the results count display
        function updateResultsCount() {
            resultsCount.textContent = filteredData.length;
        }

        // Get marker color based on category
        function getMarkerColor(category) {
            if (category === "Food") {
                return "#e53e3e"; // red
            } else if (category === "Festival") {
                return "#805ad5"; // purple
            } else if (category === "Architecture") {
                return "#3182ce"; // blue
            } else if (category === "Performance") {
                return "#dd6b20"; // orange
            } else {
                return "#718096"; // gray
            }
        }

        // Create custom marker icon
        function createCustomMarkerIcon(item) {
            const color = getMarkerColor(item.category);
            
            return L.divIcon({
                className: 'custom-marker-icon',
                html: `<div style="width: 30px; height: 30px; background-color: ${color}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${item.id}</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
        }

        // Render map markers based on filtered data
        function renderMapMarkers() {
            // Clear existing markers
            if (markers.length > 0) {
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];
            }
            
            // Add new markers based on filtered data
            filteredData.forEach(item => {
                const marker = L.marker([item.location.lat, item.location.lng], {
                    icon: createCustomMarkerIcon(item)
                }).addTo(map);
                
                // Create popup content
                const popupContent = `
                    <div class="p-2">
                        <h3 class="font-semibold">${item.title}</h3>
                        <p class="text-sm text-gray-600">${item.category} | ${item.period}</p>
                        <button class="mt-2 text-indigo-600 text-sm font-medium view-details-btn" data-id="${item.id}">
                            View Details →
                        </button>
                    </div>
                `;
                
                // Create popup
                const popup = L.popup({
                    className: 'custom-popup'
                }).setContent(popupContent);
                
                // Add popup to marker
                marker.bindPopup(popup);
                
                // Add click event
                marker.on('click', () => {
                    marker.openPopup();
                });
                
                // Add click event for "View Details" button in popup
                marker.on('popupopen', () => {
                    setTimeout(() => {  // Add a small delay to ensure DOM is ready
                        const viewDetailsBtn = document.querySelector(`.view-details-btn[data-id="${item.id}"]`);
                        if (viewDetailsBtn) {
                            viewDetailsBtn.addEventListener('click', () => {
                                selectedItem = item;
                                renderItemDetails();
                                setView('details');
                            });
                        }
                    }, 10);  // 10ms delay should be sufficient
                });
                
                // Add marker to array for later reference
                markers.push(marker);
            });
            
            // If we have markers, fit the map to show all markers
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Render thematic collections
        function renderThematicCollections() {
            themesContainer.innerHTML = '';
            
            THEMATIC_COLLECTIONS.forEach(theme => {
                const themeElement = document.createElement('div');
                themeElement.className = 'border rounded-xl overflow-hidden shadow-md hover:shadow-lg transition';
                themeElement.innerHTML = `
                    <img src="${theme.image}" alt="${theme.title}" class="w-full h-48 object-cover">
                    <div class="p-4">
                        <h2 class="text-xl font-semibold mb-2">${theme.title}</h2>
                        <p class="text-gray-600 mb-4">${theme.description}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-500">${theme.items.length} items</span>
                            <button class="bg-indigo-600 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-700 transition">
                                Explore
                            </button>
                        </div>
                    </div>
                `;
                
                // Add click event to the Explore button
                const exploreButton = themeElement.querySelector('button');
                exploreButton.addEventListener('click', () => {
                    const firstItem = CULTURAL_DATA.find(item => item.id === theme.items[0]);
                    if (firstItem) {
                        selectedItem = firstItem;
                        renderItemDetails();
                        setView('details');
                    }
                });
                
                themesContainer.appendChild(themeElement);
            });
        }
        // Render saved items
        function renderSavedItems() {
            const savedData = CULTURAL_DATA.filter(item => savedItems.includes(item.id));
            
            if (savedData.length === 0) {
                savedItemsContainer.innerHTML = `
                    <div class="text-center py-12 bg-gray-50 rounded-xl">
                        <i class="fas fa-bookmark text-gray-400 text-4xl mb-4"></i>
                        <h2 class="text-xl font-medium mb-2">No saved items yet</h2>
                        <p class="text-gray-500 mb-4">Explore the map and save cultural memories to your collection.</p>
                        <button class="bg-indigo-600 text-white px-6 py-2 rounded-full hover:bg-indigo-700 transition">
                            Explore Map
                        </button>
                    </div>
                `;
                
                // Add click event to the Explore Map button
                const exploreButton = savedItemsContainer.querySelector('button');
                exploreButton.addEventListener('click', () => setView('map'));
                
            } else {
                savedItemsContainer.innerHTML = `
                    <div class="flex flex-wrap justify-between items-center mb-4">
                        <span class="text-gray-600 mb-2 sm:mb-0">${savedData.length} items saved</span>
                        <button class="bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-200 transition">
                            Export Collection
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="saved-grid"></div>
                `;
                
                const savedGrid = savedItemsContainer.querySelector('#saved-grid');
                
                savedData.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition';
                    itemElement.innerHTML = `
                        <img src="${item.images[0]}" alt="${item.title}" class="w-full h-40 object-cover">
                        <div class="p-4">
                            <div class="flex justify-between">
                                <span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded">
                                    ${item.category}
                                </span>
                                <button class="text-gray-400 hover:text-red-500">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <h3 class="text-lg font-medium mt-2 mb-1">${item.title}</h3>
                            <p class="text-gray-500 text-sm mb-3 line-clamp-2">${item.description}</p>
                            <button class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                                View Details →
                            </button>
                        </div>
                    `;
                    
                    // Add click event to remove button
                    const removeButton = itemElement.querySelector('.fa-times').parentElement;
                    removeButton.addEventListener('click', () => {
                        toggleSaveItem(item.id);
                    });
                    
                    // Add click event to view details button
                    const viewButton = itemElement.querySelector('.text-indigo-600');
                    viewButton.addEventListener('click', () => {
                        selectedItem = item;
                        renderItemDetails();
                        setView('details');
                    });
                    
                    savedGrid.appendChild(itemElement);
                });
            }
        }

        // Render item details
        function renderItemDetails() {
            if (!selectedItem) return;
            
            const isItemSaved = savedItems.includes(selectedItem.id);
            const saveButtonClass = isItemSaved ? 'bg-indigo-100 text-indigo-700' : 'bg-gray-100 text-gray-600';
            
            detailContent.innerHTML = `
                <!-- Navigation and actions -->
                <div class="flex flex-wrap justify-between items-center mb-6">
                    <button class="flex items-center text-gray-600 hover:text-gray-900 mb-2 sm:mb-0" id="back-to-map-btn">
                        ← Back
                    </button>
                    
                    <div class="flex space-x-2">
                        <button class="p-2 rounded-full ${saveButtonClass}" id="save-item-btn">
                            <i class="fas fa-bookmark"></i>
                        </button>
                        ${isLoggedIn ? `
                            <button class="p-2 rounded-full bg-gray-100 text-gray-600">
                                <i class="fas fa-download"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Title and metadata -->
                <div class="mb-6">
                    <h1 class="text-2xl font-bold mb-2">${selectedItem.title}</h1>
                    <div class="flex flex-wrap gap-2 text-sm text-gray-500">
                        <span class="bg-gray-100 px-2 py-1 rounded">${selectedItem.category}</span>
                        <span class="bg-gray-100 px-2 py-1 rounded">${selectedItem.period}</span>
                        <span class="bg-gray-100 px-2 py-1 rounded">${selectedItem.district}</span>
                        <span class="bg-gray-100 px-2 py-1 rounded">Contributed by: ${selectedItem.contributor}</span>
                    </div>
                </div>
                
                <!-- Image gallery -->
                <div class="mb-6">
                    <div class="grid grid-cols-1 ${selectedItem.images.length > 1 ? 'md:grid-cols-2' : ''} gap-4">
                        ${selectedItem.images.map((img, i) => `
                            <img 
                                src="${img}" 
                                alt="${selectedItem.title} - image ${i+1}" 
                                class="w-full h-56 object-cover rounded-lg"
                            />
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Add audio player if available
            if (selectedItem.audio) {
                detailContent.innerHTML += `
                    <!-- Audio player -->
                    <div class="mb-6">
                        <h2 class="text-lg font-semibold mb-2">Audio Recording</h2>
                        <div class="bg-gray-100 p-3 rounded-lg flex items-center">
                            <button 
                                id="audio-play-btn"
                                class="w-10 h-10 rounded-full bg-indigo-600 text-white flex items-center justify-center"
                            >
                                <i class="fas fa-play"></i>
                            </button>
                            <div class="ml-3 flex-1">
                                <div class="h-2 bg-gray-300 rounded-full overflow-hidden">
                                    <div 
                                        id="audio-progress"
                                        class="h-full bg-indigo-600 rounded-full audio-progress" 
                                        style="width: 0%;"
                                    ></div>
                                </div>
                            </div>
                            <div class="ml-3 text-sm" id="audio-time">
                                00:00 / 03:45
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Add map showing location of the item
            detailContent.innerHTML += `
                <!-- Location map -->
                <div class="mb-6">
                    <h2 class="text-lg font-semibold mb-2">Location</h2>
                    <div id="detail-map" class="h-64 rounded-lg overflow-hidden shadow-sm"></div>
                </div>
            `;
            
            // Add description and tags
            detailContent.innerHTML += `
                <!-- Description -->
                <div class="mb-6">
                    <h2 class="text-lg font-semibold mb-2">Description</h2>
                    <p class="text-gray-700">
                        ${selectedItem.description}
                    </p>
                </div>
                
                <!-- Tags -->
                <div>
                    <h2 class="text-lg font-semibold mb-2">Tags</h2>
                    <div class="flex flex-wrap gap-2">
                        ${selectedItem.tags.map(tag => `
                            <span class="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full text-sm">
                                #${tag}
                            </span>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Add event listeners for buttons
            document.getElementById('back-to-map-btn').addEventListener('click', () => {
                // Go back to previous view
                if (currentView === 'details') {
                    setView('map');
                }
            });
            document.getElementById('save-item-btn').addEventListener('click', () => toggleSaveItem(selectedItem.id));
            
            // Initialize detail map
            setTimeout(() => {
                const detailMap = L.map('detail-map').setView([selectedItem.location.lat, selectedItem.location.lng], 15);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap contributors'
                }).addTo(detailMap);
                
                // Add marker for this item
                L.marker([selectedItem.location.lat, selectedItem.location.lng], {
                    icon: createCustomMarkerIcon(selectedItem)
                }).addTo(detailMap);
            }, 100);
            
            // Add audio player functionality if available
            if (selectedItem.audio) {
                const audioPlayBtn = document.getElementById('audio-play-btn');
                const audioProgress = document.getElementById('audio-progress');
                const audioTime = document.getElementById('audio-time');
                
                audioPlayBtn.addEventListener('click', () => {
                    audioPlaying = !audioPlaying;
                    
                    if (audioPlaying) {
                        audioPlayBtn.innerHTML = '<i class="fas fa-pause"></i>';
                        // Simulate audio progress
                        let progress = 0;
                        const audioInterval = setInterval(() => {
                            progress += 1;
                            if (progress > 100) {
                                clearInterval(audioInterval);
                                audioPlaying = false;
                                audioPlayBtn.innerHTML = '<i class="fas fa-play"></i>';
                                audioProgress.style.width = '0%';
                                audioTime.textContent = '00:00 / 03:45';
                                return;
                            }
                            
                            audioProgress.style.width = `${progress}%`;
                            
                            // Update time display
                            const currentSeconds = Math.floor((progress / 100) * 225); // 3:45 = 225 seconds
                            const currentMinutes = Math.floor(currentSeconds / 60);
                            const currentRemainingSeconds = currentSeconds % 60;
                            
                            audioTime.textContent = `${String(currentMinutes).padStart(2, '0')}:${String(currentRemainingSeconds).padStart(2, '0')} / 03:45`;
                        }, 100);
                    } else {
                        audioPlayBtn.innerHTML = '<i class="fas fa-play"></i>';
                        // In a real app, would pause the audio here
                    }
                });
            }
        }

        // Toggle save/unsave item
        function toggleSaveItem(itemId) {
            if (!isLoggedIn) {
                toggleLoginModal(true);
                return;
            }
            
            if (savedItems.includes(itemId)) {
                savedItems = savedItems.filter(id => id !== itemId);
            } else {
                savedItems.push(itemId);
            }
            
            // Save to localStorage
            localStorage.setItem('citysoul-saved-items', JSON.stringify(savedItems));
            
            // Update UI
            updateSavedItemsCount();
            
            // If in details view, update the save button
            if (currentView === 'details' && selectedItem && selectedItem.id === itemId) {
                const saveButton = document.getElementById('save-item-btn');
                if (savedItems.includes(itemId)) {
                    saveButton.className = 'p-2 rounded-full bg-indigo-100 text-indigo-700';
                } else {
                    saveButton.className = 'p-2 rounded-full bg-gray-100 text-gray-600';
                }
            }
            
            // If in saved view, re-render saved items
            if (currentView === 'saved') {
                renderSavedItems();
            }
        }

        // Update the saved items count display
        function updateSavedItemsCount() {
            savedCountElements.forEach(element => {
                element.textContent = savedItems.length;
            });
        }

        // Handle login
        function handleLogin() {
            isLoggedIn = true;
            localStorage.setItem('citysoul-logged-in', 'true');
            toggleLoginModal(false);
            updateLoginButton();
            
            // If trying to access saved items, show the saved view
            if (currentView === 'map') {
                setView('saved');
            }
        }

        // Update the login button based on login status
        function updateLoginButton() {
            const loginBtn = document.getElementById('login-btn');
            if (isLoggedIn) {
                loginBtn.innerHTML = '<i class="fas fa-user mr-1"></i> My Account';
            } else {
                loginBtn.innerHTML = '<i class="fas fa-user mr-1"></i> Log In';
            }
        }

        // Toggle the login modal
        function toggleLoginModal(show) {
            if (show) {
                loginModal.classList.remove('hidden');
            } else {
                loginModal.classList.add('hidden');
            }
        }

        // Toggle the mobile menu
        function toggleMobileMenu(show) {
            if (show === undefined) {
                mobileMenu.classList.toggle('hidden');
            } else if (show) {
                mobileMenu.classList.remove('hidden');
            } else {
                mobileMenu.classList.add('hidden');
            }
        }

        // Set current view
        function setView(view) {
            currentView = view;
            
            // Hide all views
            mapView.classList.add('hidden');
            detailsView.classList.add('hidden');
            themesView.classList.add('hidden');
            savedView.classList.add('hidden');
            socialServiceView.classList.add('hidden');
            
            // Update navigation highlighting
            document.getElementById('map-nav-btn').classList.remove('font-bold');
            document.getElementById('themes-nav-btn').classList.remove('font-bold');
            document.getElementById('saved-nav-btn').classList.remove('font-bold');
            document.getElementById('social-service-btn').classList.remove('font-bold');
            
            // Show selected view and highlight nav
            if (view === 'map') {
                mapView.classList.remove('hidden');
                document.getElementById('map-nav-btn').classList.add('font-bold');
                // Force map to recalculate size when it becomes visible
                setTimeout(() => {
                    if (map) map.invalidateSize();
                }, 100);
            } else if (view === 'details') {
                detailsView.classList.remove('hidden');
            } else if (view === 'themes') {
                themesView.classList.remove('hidden');
                document.getElementById('themes-nav-btn').classList.add('font-bold');
            } else if (view === 'saved') {
                savedView.classList.remove('hidden');
                renderSavedItems();
                document.getElementById('saved-nav-btn').classList.add('font-bold');
            } else if (view === 'social-service') {
                socialServiceView.classList.remove('hidden');
                document.getElementById('social-service-btn').classList.add('font-bold');
            }
        }

        // Start the application when the page loads
        window.addEventListener('DOMContentLoaded', initApp);
    // </script>
</body>
</html>